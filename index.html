<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Table Compare Tool</title>
  <style>
    .table-container {
      display: flex;
      gap: 20px;
      overflow-x: auto;
      margin-top: 10px;
    }
    table, td {
      border: 1px solid black;
      border-collapse: collapse;
      padding: 5px;
    }
    .different {
      background-color: red;
    }
    .manipulation-inputs {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div>
    <textarea id="input1" placeholder="Paste Table 1 from Excel" oninput="updateManipulationInputs()" rows="8" cols="40"></textarea>
    <textarea id="input2" placeholder="Paste Table 2 from Excel" rows="8" cols="40"></textarea>

    <div class="manipulation-inputs" id="manipulationInputs">
      <!-- Dynamic inputs for column manipulation values -->
    </div>

    <button onclick="compareTables()">Compare</button>
  </div>

  <div class="table-container">
    <div id="table1"></div>
    <div id="table2"></div>
  </div>

  <script>
    function parseCell(cell) {
      const cleaned = cell.trim().replace(',', '.'); // Normalize comma to dot
      const match = cleaned.match(/^(-?\d+(?:\.\d+)?)(\s*\D.*)?$/);
      if (match) {
        return {
          num: parseFloat(match[1]),
          str: (match[2] || '').trim()
        };
      } else {
        return { num: null, str: cleaned };
      }
    }

    function parseExcelText(text) {
      return text.trim().split('\n').map(row => row.split('\t'));
    }

    function updateManipulationInputs() {
      const data = parseExcelText(document.getElementById('input1').value);
      const container = document.getElementById('manipulationInputs');
      container.innerHTML = '';

      if (data.length === 0 || data[0].length === 0) return;

      const maxCols = Math.max(...data.map(row => row.length));
      container.innerHTML = '<b>LSD:</b><br>';

      for (let i = 0; i < maxCols; i++) {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = `Col ${i + 1}`;
        input.dataset.col = i;
        container.appendChild(input);
      }
    }

    function getManipulationValues() {
      const inputs = document.querySelectorAll('#manipulationInputs input');
      return Array.from(inputs).map(input => input.value);
    }

    function processEach(n, e) {
      const map = group([...n], parseFloat(e));
      const processedList = new Array(n.length);

      for (let m = 0; m < processedList.length; m++) {
        processedList[m] = `${n[m]} ${map.get(parseFloat(n[m]))}`;
      }

      return processedList;
    }

    function group(n, e) {
      n = n.map(x => parseFloat(x));
      n.sort((a, b) => a - b);
      reverse(n);

      const result = new Array(n.length).fill("");

      const groups = ["a", "b", "c", "d"];
      let groupCount = 0;
      let groupName = groups[groupCount];
      let i = 0;

      while (i < n.length) {
        let limit = n[i] - e;
        while (i < n.length && n[i] >= limit) {
          result[i] += groupName;
          i++;
        }
        if (i === n.length) break;

        groupName = groups[++groupCount % groups.length];
        let begin = n[i] + e;
        let a = i - 1;
        while (a >= 0 && n[a] <= begin) {
          a--;
        }
        i = a + 1;
      }

      const resultGroup = new Map();
      for (let k = 0; k < n.length; k++) {
        resultGroup.set(n[k], result[k]);
      }

      return resultGroup;
    }

    function reverse(arr) {
      let n = arr.length;
      for (let i = 0; i < Math.floor(n / 2); i++) {
        let temp = arr[i];
        arr[i] = arr[n - i - 1];
        arr[n - i - 1] = temp;
      }
    }

    function transpose(matrix) {
      const rows = matrix.length;
      const cols = Math.max(...matrix.map(row => row.length));
      const transposed = Array.from({ length: cols }, () => Array(rows).fill(""));
      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < matrix[i].length; j++) {
          transposed[j][i] = matrix[i][j];
        }
      }
      return transposed;
    }

    function compareTables() {
      const raw1 = parseExcelText(document.getElementById('input1').value);
      const raw2 = parseExcelText(document.getElementById('input2').value);
      const values = getManipulationValues();

      const transposed = transpose(raw1);
      const manipulatedCols = transposed.map((col, i) => processEach(col, values[i] ?? '0'));
      const manipulatedRows = transpose(manipulatedCols);

      const maxRows = Math.max(manipulatedRows.length, raw2.length);
      const maxCols = Math.max(...[...manipulatedRows, ...raw2].map(row => row.length));
      const diffs = Array.from({ length: maxRows }, () => Array(maxCols).fill(false));

      for (let i = 0; i < maxRows; i++) {
        for (let j = 0; j < maxCols; j++) {
          const val1 = manipulatedRows[i]?.[j] ?? '';
          const val2 = raw2[i]?.[j] ?? '';
          const p1 = parseCell(val1);
          const p2 = parseCell(val2);
          if (p1.num !== null && p2.num !== null) {
            if (p1.num !== p2.num || p1.str !== p2.str) {
              diffs[i][j] = true;
            }
          } else {
            if (val1.trim() !== val2.trim()) {
              diffs[i][j] = true;
            }
          }
        }
      }

      renderTable(document.getElementById('table1'), manipulatedRows, diffs);
      renderTable(document.getElementById('table2'), raw2, diffs);

      // Clear inputs
      document.getElementById('input1').value = '';
      document.getElementById('input2').value = '';
      document.getElementById('manipulationInputs').innerHTML = '';
    }

    function renderTable(container, data, diffs) {
      const table = document.createElement('table');
      data.forEach((row, i) => {
        const tr = document.createElement('tr');
        row.forEach((cell, j) => {
          const td = document.createElement('td');
          td.textContent = cell;
          if (diffs && diffs[i] && diffs[i][j]) {
            td.classList.add('different');
          }
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });
      container.innerHTML = '';
      container.appendChild(table);
    }
  </script>

</body>
</html>
